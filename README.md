# Telegram Discount Bot

Бот выдает купон на 10% только подписчикам вашего канала, проводит anti-bot проверку перед выдачей и позволяет администратору проверять валидность купона.

## Логика валидности купона

Купон валиден только если одновременно:
- купон существует;
- купон еще не использован;
- владелец купона в момент проверки все еще подписан на канал.

Если человек отписался от канала, бот вернет, что купон невалиден.

## Anti-bot проверка перед /coupon

Перед выдачей купона пользователь проходит математическую challenge:
- 2 шага по умолчанию (inline-кнопки с вариантами ответов);
- время на каждый шаг ограничено (`CAPTCHA_TTL_MS`);
- после нескольких ошибок подряд включается пауза (`CAPTCHA_COOLDOWN_MS`);
- после успешного прохождения пользователь считается доверенным на время (`CAPTCHA_TRUST_MS`).

## Гарантия уникальности купонов

Купон генерируется по монотонному счетчику (`lastCouponId`) и кодируется в base36:
- формат: `D10-XXXXXX` (например `D10-00000A`);
- каждый новый ID уникален, значит и код уникален;
- дубликаты исключены даже при генерации более 1,000,000 купонов.

## Команды

Пользователь:
- `/start` - помощь;
- `/coupon` - получить купон (после anti-bot проверки и проверки подписки);
- `/mycoupon` - показать свой купон.

Администратор (только `ADMIN_IDS`):
- `/check КОД` - проверить валидность купона;
- `/use КОД` - пометить купон как использованный.

Поведение выдачи:
- пользователь получает купон только 1 раз навсегда;
- повторная выдача невозможна даже если купон уже использован.

## Подготовка

1. Создайте бота через BotFather и получите токен.
2. Добавьте бота в канал.
3. Выдайте боту права администратора в канале (чтобы он мог проверять подписку через `getChatMember`).
4. Скопируйте `.env.example` в `.env` и заполните значения.

Обязательные переменные:
- `BOT_TOKEN`
- `CHANNEL_ID`
- `ADMIN_IDS`
- `DATA_FILE`

Опциональные настройки anti-bot:
- `CAPTCHA_STEPS` (по умолчанию `2`)
- `CAPTCHA_TTL_MS` (по умолчанию `90000`)
- `CAPTCHA_MAX_FAILURES` (по умолчанию `3`)
- `CAPTCHA_COOLDOWN_MS` (по умолчанию `600000`)
- `CAPTCHA_TRUST_MS` (по умолчанию `1800000`)

## Запуск

```bash
npm install
npm run start
```

Проверка синтаксиса:

```bash
npm run check
```

## VPS

Готовый безопасный сценарий деплоя (без вмешательства в текущий домен/сервис) описан в `DEPLOY_VPS.md`.
